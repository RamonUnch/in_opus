CC=gcc

CFLAGS=-I. -I./opus \
    -Og -g \
    -Wall -Wextra \
    -Wno-unused-parameter \
    -fno-stack-check \
    -fno-stack-protector \
    -mno-stack-arg-probe \
    -momit-leaf-frame-pointer \
    -march=i486 -mtune=i686 \
    -fanalyzer \
    -fno-ident \
    -mpreferred-stack-boundary=2 \
    -foptimize-strlen \
 	-fno-exceptions \
	-fno-dwarf2-cfi-asm \
	-fno-asynchronous-unwind-tables \
    -Wstack-usage=4096 \
    -fgcse-sm \
    -fgcse-las \
	-D__USE_MINGW_ANSI_STDIO=0 \
	-DLOCAL_LRINTF


#    -fomit-frame-pointer \

# -freorder-blocks -fweb -frename-registers -funswitch-loops\
# -fwhole-program -fstrict-aliasing -fschedule-insns
# -D__SSE1 sse_func.o

LDFLAGS= -nostdlib -lgcc -lm -lkernel32 -lmsvcrt -luser32 -lgdi32 -lwsock32
LDFLAGS+= -Wl,-dynamicbase \
    -Wl,-nxcompat \
    -Wl,--no-seh \
    -Wl,--relax \
    -Wl,--enable-auto-import \
    -Wl,--disable-stdcall-fixup

in_opus.dll: in_opus.o resample.o infobox.o http.o wspiapi.o resource.o
	$(CC) -o in_opus.dll in_opus.o resample.o infobox.o http.o wspiapi.o resource.o\
	 libopus152.a logg/*.c opusfile/*.c -e_DllMain@12 -mdll $(LDFLAGS) $(CFLAGS)

	cp in_opus.dll "D:\Program Files\MediaPlayers\Winamp\Plugins"
	cp in_opus.dll "D:\Shared docs"
	cp in_opus.dll "D:\Program Files\MediaPlayers\winamp566\Plugins"
	cp in_opus.dll "D:\Program Files\MediaPlayers\winamp58\Plugins"
	cp in_opus.dll "D:\Program Files\MediaPlayers\winamp531\Plugins"
	cp in_opus.dll "D:\Program Files\MediaPlayers\MediaMonkey3\Plugins"
	cp in_opus.dll "D:\Program Files\MediaPlayers\MediaMonkey4\Plugins"

in_opus.o : in_opus.c infobox.h resample.h resource.h
	$(CC) -c in_opus.c $(CFLAGS)
infobox.o : infobox.c infobox.h utf_ansi.c
	$(CC) -c infobox.c $(CFLAGS)
resource.o: resource.rc
	windres resource.rc resource.o
wspiapi.o : wspiapi.c wspiapi.h
	$(CC) -c wspiapi.c $(CFLAGS)
http.o    : http.c http.h wspiapi.h winerrno.h
	$(CC) -c http.c  $(CFLAGS)
resample.o: resample.c resample.h
	$(CC) -c resample.c $(CFLAGS) -O2 -ffast-math
#sse_func.o: sse_func.c sse_func.h
#	$(CC) -c sse_func.c $(CFLAGS) -msse -O2 -ffast-math -fno-lto
#dietlibc.o: dietlibc.c dietlibc.h
#	$(CC) -c dietlibc.c  $(CFLAGS)

clean :
	rm *.o in_opus.dll
